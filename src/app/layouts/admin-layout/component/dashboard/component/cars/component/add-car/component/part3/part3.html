<div class="accordion-body bg-gradient-to-br from-gray-50 to-gray-100 p-6">
  <!-- Enhanced Loading State -->
  <div *ngIf="isFieldFocused && focusedField" class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
    <div class="flex items-center">
      <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
      <p class="text-blue-800 text-sm font-medium">
        جاري تحديث الاقتراحات للحقل المحدد...
      </p>
    </div>
  </div>

  <div class="space-y-8">
    <!-- Enhanced Progress Indicator -->
    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-gray-600">تقدم إكمال البيانات</span>
        <span class="text-sm text-gray-500">{{ getCompletionPercentage() }}%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300"
          [style.width.%]="getCompletionPercentage()" [attr.aria-valuenow]="getCompletionPercentage()"
          [attr.aria-valuemin]="0" [attr.aria-valuemax]="100">
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-1">تم ملء {{ getFilledFieldsCount() }} من {{ getTotalFieldsCount() }} حقول</p>
    </div>

    <!-- Smart Suggestions Panel -->
    <div *ngIf="smartSuggestions.optimalDownPaymentPercent || smartSuggestions.suggestedMonthlyPayment || smartSuggestions.discountSavings" 
         class="bg-amber-50 border border-amber-200 rounded-lg p-4">
      <h4 class="font-semibold text-amber-800 mb-3 flex items-center">
        <i class="fas fa-lightbulb mr-2"></i>
        <span>اقتراحات ذكية</span>
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div *ngIf="smartSuggestions.optimalDownPaymentPercent" 
             class="bg-white p-3 rounded border border-amber-200">
          <small class="text-gray-600 d-block">الدفعة الأولى المثلى</small>
          <div class="flex items-center justify-between">
            <span class="text-lg font-semibold text-green-600">{{ smartSuggestions.optimalDownPaymentPercent }}%</span>
            <button type="button" 
                    class="text-xs px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700"
                    (click)="applyOptimalDownPayment()">
              تطبيق
            </button>
          </div>
        </div>
        
        <div *ngIf="smartSuggestions.suggestedMonthlyPayment" 
             class="bg-white p-3 rounded border border-amber-200">
          <small class="text-gray-600 d-block">القسط الشهري المقترح</small>
          <div class="flex items-center justify-between">
            <span class="text-lg font-semibold text-blue-600">{{ smartSuggestions.suggestedMonthlyPayment | number:'1.0-0' }} ريال</span>
            <button type="button" 
                    class="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                    (click)="applySuggestedMonthlyPayment()">
              تطبيق
            </button>
          </div>
        </div>
        
        <div *ngIf="smartSuggestions.discountSavings" 
             class="bg-white p-3 rounded border border-amber-200">
          <small class="text-gray-600 d-block">توفير من الخصم</small>
          <span class="text-lg font-semibold text-yellow-600">{{ smartSuggestions.discountSavings | number:'1.0-0' }} ريال</span>
        </div>
      </div>
      
      <!-- Validation Hints -->
      <div *ngIf="smartSuggestions.validationHints.length > 0" class="mt-4">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle text-amber-500 mr-2 mt-0.5"></i>
          <div>
            <strong class="text-amber-800">ملاحظات:</strong>
            <ul class="mt-1 space-y-1">
              <li *ngFor="let hint of smartSuggestions.validationHints" class="text-amber-700 text-sm">
                • {{ hint }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Financing Calculations Display -->
    <div *ngIf="financingCalculation" class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
      <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
        <i class="fas fa-calculator mr-2 text-blue-600"></i>
        <span>حسابات التمويل</span>
      </h4>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div class="p-3 bg-blue-50 rounded">
          <small class="text-gray-600 d-block">السعر الإجمالي</small>
          <span class="text-lg font-semibold text-blue-600">{{ financingCalculation.totalPrice | number:'1.0-0' }} ريال</span>
        </div>
        <div *ngIf="financingCalculation.discountedPrice !== financingCalculation.totalPrice" 
             class="p-3 bg-green-50 rounded">
          <small class="text-gray-600 d-block">السعر بعد الخصم</small>
          <span class="text-lg font-semibold text-green-600">{{ financingCalculation.discountedPrice | number:'1.0-0' }} ريال</span>
        </div>
        <div class="p-3 bg-purple-50 rounded">
          <small class="text-gray-600 d-block">مبلغ التمويل</small>
          <span class="text-lg font-semibold text-purple-600">{{ financingCalculation.financingAmount | number:'1.0-0' }} ريال</span>
        </div>
        <div class="p-3 bg-yellow-50 rounded">
          <small class="text-gray-600 d-block">إجمالي الفوائد</small>
          <span class="text-lg font-semibold text-yellow-600">{{ financingCalculation.totalInterest | number:'1.0-0' }} ريال</span>
        </div>
      </div>
    </div>

    <!-- Form Fields Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Price Field -->
      <div class="space-y-2">
        <label for="inputPrice" class="form-label font-semibold text-gray-700 flex items-center">
          <i class="fas fa-dollar-sign mr-2 text-green-500"></i>
          <span>السعر</span>
          <span class="text-red-500 mr-1">*</span>
        </label>
        <input type="number"
          class="form-control transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 part3-field"
          id="inputPrice" name="price" [ngModel]="carData.price" 
          (ngModelChange)="onPriceChange($event)" (focus)="onFieldFocus('price')" 
          (blur)="onFieldBlur()" placeholder="0" min="1000"
          [class.is-invalid]="hasFieldError('price')"
          [attr.aria-describedby]="hasFieldError('price') ? 'price-error' : null"
          [attr.aria-invalid]="hasFieldError('price')">
        <div class="text-red-500 text-sm mt-1" id="price-error" *ngIf="hasFieldError('price')">
          <i class="fas fa-exclamation-circle mr-1"></i>
          {{ getFieldError('price') }}
        </div>
      </div>

      <!-- Discount Field -->
      <div class="space-y-2">
        <label for="inputDiscount" class="form-label font-semibold text-gray-700 flex items-center">
          <i class="fas fa-percentage mr-2 text-yellow-500"></i>
          <span>الخصم (%)</span>
        </label>
        <input type="number"
          class="form-control transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 part3-field"
          id="inputDiscount" name="discount" [ngModel]="carData.discount" 
          (ngModelChange)="onDiscountChange($event)" (focus)="onFieldFocus('discount')" 
          (blur)="onFieldBlur()" placeholder="0" min="0" max="50"
          [class.is-invalid]="hasFieldError('discount')"
          [attr.aria-describedby]="hasFieldError('discount') ? 'discount-error' : null"
          [attr.aria-invalid]="hasFieldError('discount')">
        <div class="text-red-500 text-sm mt-1" id="discount-error" *ngIf="hasFieldError('discount')">
          <i class="fas fa-exclamation-circle mr-1"></i>
          {{ getFieldError('discount') }}
        </div>
      </div>

      <!-- Down Payment Field -->
      <div class="space-y-2">
        <label for="inputDownpayment" class="form-label font-semibold text-gray-700 flex items-center">
          <i class="fas fa-credit-card mr-2 text-blue-500"></i>
          <span>الدفعة الأولى</span>
        </label>
        <input type="number"
          class="form-control transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 part3-field"
          id="inputDownpayment" name="down_payment" [ngModel]="carData.down_payment" 
          (ngModelChange)="onDownPaymentChange($event)" (focus)="onFieldFocus('down_payment')" 
          (blur)="onFieldBlur()" placeholder="0" min="0"
          [class.is-invalid]="hasFieldError('down_payment')"
          [attr.aria-describedby]="hasFieldError('down_payment') ? 'downpayment-error' : null"
          [attr.aria-invalid]="hasFieldError('down_payment')">
        <div class="text-red-500 text-sm mt-1" id="downpayment-error" *ngIf="hasFieldError('down_payment')">
          <i class="fas fa-exclamation-circle mr-1"></i>
          {{ getFieldError('down_payment') }}
        </div>
      </div>

      <!-- Monthly Installment Field -->
      <div class="space-y-2">
        <label for="inputInstallment" class="form-label font-semibold text-gray-700 flex items-center">
          <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
          <span>القسط الشهري</span>
        </label>
        <input type="number"
          class="form-control transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 part3-field"
          id="inputInstallment" name="monthly_installment" [ngModel]="carData.monthly_installment" 
          (ngModelChange)="onMonthlyInstallmentChange($event)" (focus)="onFieldFocus('monthly_installment')" 
          (blur)="onFieldBlur()" placeholder="0" min="100"
          [class.is-invalid]="hasFieldError('monthly_installment')"
          [attr.aria-describedby]="hasFieldError('monthly_installment') ? 'installment-error' : null"
          [attr.aria-invalid]="hasFieldError('monthly_installment')">
        <div class="text-red-500 text-sm mt-1" id="installment-error" *ngIf="hasFieldError('monthly_installment')">
          <i class="fas fa-exclamation-circle mr-1"></i>
          {{ getFieldError('monthly_installment') }}
        </div>
      </div>

      <!-- Trim Selection -->
      <div class="md:col-span-2 space-y-2">
        <label for="inputTrim" class="form-label font-semibold text-gray-700 flex items-center">
          <i class="fas fa-car mr-2 text-indigo-500"></i>
          <span>نسخة السيارة</span>
          <span class="text-red-500 mr-1">*</span>
        </label>
        <select
          class="form-select transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 part3-field"
          id="inputTrim" name="trim" [ngModel]="carData.trim"
          (ngModelChange)="onTrimChange($event)" (focus)="onFieldFocus('trim')" (blur)="onFieldBlur()"
          [class.is-invalid]="hasFieldError('trim')"
          [attr.aria-describedby]="hasFieldError('trim') ? 'trim-error' : null"
          [attr.aria-invalid]="hasFieldError('trim')">
          <option value="" selected disabled>اختر نسخة السيارة...</option>
          <option *ngFor="let trim of trims" [value]="trim.value">
            {{ trim.label }} - {{ trim.description }}
          </option>
        </select>
        <div class="text-red-500 text-sm mt-1" id="trim-error" *ngIf="hasFieldError('trim')">
          <i class="fas fa-exclamation-circle mr-1"></i>
          {{ getFieldError('trim') }}
        </div>
      </div>
    </div>

    <!-- Enhanced Image Upload -->
    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
      <label class="form-label font-semibold text-gray-700 flex items-center mb-3">
        <i class="fas fa-images mr-2 text-pink-500"></i>
        <span>صور السيارة</span>
        <span class="text-xs text-gray-500 mr-2">(الحد الأقصى {{ maxImages }} صور)</span>
      </label>
      
   <!-- Drag and Drop Area -->
<div class="upload-area relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center transition-all duration-200 hover:border-blue-400"
     [class.border-blue-500]="isDragOver"
     [class.bg-blue-50]="isDragOver"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDrop($event)">

  <div *ngIf="!isUploadingImages && imageUploadResults.length === 0">
    <i class="fas fa-cloud-upload-alt fa-4x text-gray-400 mb-3"></i>
    <h6 class="text-gray-600">اسحب الصور هنا أو اضغط للاختيار</h6>
    <p class="text-gray-500 text-sm">يدعم: JPG, PNG, WEBP, GIF (الحد الأقصى: {{ maxFileSize / (1024 * 1024) }}MB)</p>
  </div>

  <div *ngIf="isUploadingImages" class="flex items-center justify-center">
    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
    <span class="text-blue-600">جاري رفع الصور...</span>
  </div>

  <input
    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
    type="file"
    id="formFile"
    multiple
    (change)="onFileChange($event)"
    accept="image/*">
</div>


      <!-- Image Previews -->
      <div class="mt-4" *ngIf="imageUploadResults.length > 0">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
          <div *ngFor="let uploadResult of imageUploadResults; let i = index" 
               class="relative group">
            
            <!-- Upload Progress -->
            <div *ngIf="uploadResult.isUploading" 
                 class="absolute inset-0 bg-white bg-opacity-90 rounded flex items-center justify-center z-10">
              <div class="text-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mb-1"></div>
                <div class="text-xs text-gray-600">{{ uploadResult.uploadProgress | number:'1.0-0' }}%</div>
              </div>
            </div>

            <!-- Error State -->
            <div *ngIf="uploadResult.error" 
                 class="absolute inset-0 bg-red-100 bg-opacity-90 rounded flex items-center justify-center z-10">
              <div class="text-center text-red-600">
                <i class="fas fa-exclamation-triangle fa-lg mb-1"></i>
                <div class="text-xs">{{ uploadResult.error }}</div>
              </div>
            </div>

            <!-- Image Preview -->
            <img *ngIf="!uploadResult.isUploading && !uploadResult.error" 
                 [src]="uploadResult.preview" 
                 class="w-full h-24 object-cover rounded border border-gray-200"
                 [alt]="'Preview ' + (i + 1)">
            
            <!-- Remove Button -->
            <button type="button"
                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity z-20 hover:bg-red-600"
                    (click)="removeImage(i)"
                    [attr.aria-label]="'Remove image ' + (i + 1)">
              <i class="fas fa-times"></i>
            </button>

            <!-- File Info -->
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs p-1 rounded-b truncate">
              {{ uploadResult.size }}
            </div>
          </div>
        </div>
      </div>

      <!-- Image Upload Errors -->
      <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded" *ngIf="imageUploadErrors.length > 0">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle text-yellow-500 mr-2 mt-0.5"></i>
          <div>
            <strong class="text-yellow-800">أخطاء رفع الصور:</strong>
            <ul class="mt-1 space-y-1">
              <li *ngFor="let error of imageUploadErrors" class="text-yellow-700 text-sm">
                • {{ error }}
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Validation Summary -->
    <div *ngIf="hasValidationErrors()" class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-4 border border-red-200" role="alert" aria-live="polite">
      <h4 class="font-semibold text-red-800 mb-3 flex items-center">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        يرجى تصحيح الأخطاء التالية
        <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full ml-2">
          {{ getValidationErrors().length }} خطأ
        </span>
      </h4>
      <ul class="space-y-2">
        <li *ngFor="let error of getValidationErrors()" class="flex items-start text-red-700 text-sm">
          <i class="fas fa-times-circle text-red-500 mr-2 mt-0.5 flex-shrink-0"></i>
          <span>{{ error }}</span>
        </li>
      </ul>
    </div>

    <!-- Success Message -->
    <div *ngIf="isFormValid()" class="bg-green-50 border border-green-200 rounded-lg p-4">
      <div class="flex items-center">
        <i class="fas fa-check-circle text-green-500 mr-2"></i>
        <span class="text-green-700 font-medium">ممتاز! جميع البيانات مكتملة وصحيحة. يمكنك المتابعة.</span>
      </div>
    </div>

    <!-- Auto-save Status -->
    <div *ngIf="isFieldFocused" class="bg-blue-50 border border-blue-200 rounded-lg p-3">
      <div class="flex items-center">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
        <span class="text-blue-700 text-sm">يتم الحفظ التلقائي...</span>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
      <button type="button"
        class="flex-1 px-6 py-3 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-lg hover:from-gray-200 hover:to-gray-300 transition-all duration-200 font-medium disabled:opacity-50"
        (click)="triggerAutoSave()" [disabled]="isFieldFocused">
        <i class="fas fa-save mr-2"></i>
        حفظ تلقائي
      </button>

      <button type="button"
        class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-blue-600 text-white rounded-lg hover:from-green-600 hover:to-blue-700 transition-all duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden"
        (click)="triggerAutoSave()" [disabled]="!isFormValid()">
        <div class="flex items-center justify-center">
          <i class="fas fa-check mr-2"></i>
          <span>{{ !isFormValid() ? 'أكمل البيانات' : 'بيانات صحيحة' }}</span>
        </div>
        <!-- Progress indicator when form is valid -->
        <div *ngIf="isFormValid()"
          class="absolute bottom-0 left-0 h-1 bg-white bg-opacity-30 transition-all duration-1000"
          [style.width.%]="getCompletionPercentage()">
        </div>
      </button>
    </div>

    <!-- Keyboard shortcuts help -->
    <div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
      <h5 class="text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-keyboard mr-2"></i>
        اختصارات لوحة المفاتيح
      </h5>
      <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
        <div><kbd class="px-2 py-1 bg-white rounded border">Tab</kbd> للانتقال للحقل التالي</div>
        <div><kbd class="px-2 py-1 bg-white rounded border">Enter</kbd> للحقل التالي</div>
        <div><kbd class="px-2 py-1 bg-white rounded border">Esc</kbd> لمسح الحقل</div>
        <div><kbd class="px-2 py-1 bg-white rounded border">Ctrl+S</kbd> للحفظ السريع</div>
      </div>
    </div>
  </div>
</div>

<!-- Accessibility announcements -->
<div aria-live="polite" aria-atomic="true" class="sr-only">
  {{ getAccessibilityAnnouncement() }}
</div>